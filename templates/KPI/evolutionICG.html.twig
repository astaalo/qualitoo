{% extends 'configuration/index.html.twig' %}

{% block menu_config %}
	{% include 'configuration/identificationKpi.html.twig' with {position: carto} %}
{% endblock %}


{% block header_config %}
<div class="header">
	<span>
		<span class="ico color spreadsheet"></span>Evolution ICG par année
	</span>
	<div id="buttom_top">
		<ul class="uibutton-group">
			<li><a class="uibutton icon filter on_load_filter" name="#filter_content" href="#">Filtrer</a></li>
			<li><a class="uibutton icon download" href="{{ path('export_pour_kpi') }}">Extraire</a></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content_config %}
<div id="filter_content" hidden>
									{% include 'KPI/filter.html.twig' with {show_filter_for : 'eicg',form: form,link : app.request.attributes.get('_route') , carto:carto} %}
								</div>
<div id="main_content" class="content" style="background-color: #fff;">
 <div class="content" > <br  class="clear"/>
  <div class="grid1 rightzero" style="width: 24%; float: left;     margin: 0 10px 10px 20px;">
        <div class="shoutcutBox " onclick="location.href='{{ path('choix_carto_kpi', {carto: 1, type: 0, link:'rcc'}) }}'"> <span class="ico color stats_pie"></span> <strong>C/M</strong> <em>Répartition et comparaison Criticité /Maitrise</em> </a></div>
        <div class="shoutcutBox " onclick="location.href='{{ path('choix_carto_kpi', {carto: 1, type: -1, link:'rrc'}) }}'"> <span class="ico color stats_lines"></span> <strong>RRC</strong> <em>Répartition des risques par niveau de criticité</em> </a></div>
        <div class="breaks"><span></span></div>     <!--  // breaks -->	
        {% if has_rights('ROLE_ADMIN') or has_rights('ROLE_RISKMANAGER') %}
        <div class="shoutcutBox " onclick="location.href='{{ path('choix_carto_kpi', {carto: 1, type: -1, link:'rt'}) }}'"> <span class="ico color stats_bars"></span> <strong>RT</strong> <em>Risques transverses</em> </a></div>
        <div class="shoutcutBox " onclick="location.href='{{ path('choix_carto_kpi', {carto: 1, type: -1, link:'rav'}) }}'"> <span class="ico color stats_pie"></span> <strong>RA</strong> <em>Risques Avérés</em> </a></div>
        <div class="breaks"><span></span></div>     <!--  // breaks -->	
        {% endif %}
        <div class="shoutcutBox" onclick="location.href='{{ path('choix_carto_kpi', {carto: 1,type: -1,link:'cmc'}) }}'"> <span class="ico color stats_lines"></span> <strong>CMC</strong> <em>Comparaison de la maturité des contrôles avant /après test</em> </a></div>
        <div class="shoutcutBox " onclick="location.href='{{ path('choix_carto_kpi', {carto: 1, type: -1, link:'tprc'}) }}'"> <span class="ico color stats_pie"></span> <strong>%</strong> <em>Prises en charges des risques et controles testés</em> </a></div>
        <div class="shoutcutBox activebis" onclick="location.href='{{ path('choix_carto_kpi', {carto: 1, type: -1, link:'eicg'}) }}'"> <span class="ico color stats_bars"></span> <strong>ICG</strong> <em>Evolution ICG par année</em> </a></div>
	</div>
<div class="grid3" style="width: 70%;margin-left: 25px;overflow:hidden;"> 
      <div id="uploadTab">
                 <ul class="tabs">
                          <li ><a href="#tab1">Mode tableau</a></li>  
                          <li class="active" ><a href="#tab2">Mode graphe</a></li>            
                      </ul>
                      <div class="tab_container" >
                          <div id="tab1" class="tab_content">
                             {% if kpis['global'] is not empty %}
                            <table border="1" class="display " id="tabeicg" style="border: 2px;">
                                <thead>
                                  <tr role="row">
	                                  <th width="352" align="left" class="sorting_disabled" role="columnheader" rowspan="2" colspan="1" aria-label="Name" style="width: 319px;background-color:#ff8800;color:white; font-weight:bold;">Risque</th>
	                                  {% for  key,tab in kpis['global'] %}
	                                  	 <th width="174" class="sorting_disabled" role="columnheader" rowspan="1" colspan="4" aria-label="Type" style="width: 100px; background:#33ccff;">Evaluation {{ key }}</th>
	                                  {% endfor %}
                                 </tr>
                                 
                                  <tr role="row">
                                      {% for  key,tab in kpis['global'] %}
	                                  	<th width="246" class="sorting_disabled" role="columnheader" rowspan="1" colspan="1" aria-label="Show ID" style="width: 80px; background-color: #ffcc00;">Probabilite</th>
	                                    <th width="199" class="sorting_disabled" role="columnheader" rowspan="1" colspan="1" aria-label="Management" style="width: 80px; background-color: #ffcc00;">Gravité</th>
	                                    <th width="199" class="sorting_disabled" role="columnheader" rowspan="1" colspan="1" aria-label="Management" style="width: 80px; background-color: #ffcc00;">Criticité</th>
	                                    <th width="199" class="sorting_disabled" role="columnheader" rowspan="1" colspan="1" aria-label="Management" style="width: 80px; background-color: #ffcc00;">Maturité</th>
	                                  {% endfor %}
                                 </tr>
                                 
                                </thead>
                                
                              <tbody role="alert" aria-live="polite" aria-relevant="all">
	                              	  {% for key,tab in kpis['risque'] %}
	                              	   <tr class="odd">
	                              	    {% for cle,val in tab %}
			                              	    {% if loop.index == 1 %}
				                              	           <td><b>{{ val['libelle'] }}</b></td>
				                              	{% endif %}
					                              	       <td>{{ val['probabilite'] }}</td>
					                              	       <td>{{ val['gravite'] }}</td>
					                              	       <td>{{ val['criticite'] }}</td>
					                              	       <td style="border-right: 1px dotted #d6d6d6;">{{ val['maturite'] }}</td>
			                              {% endfor %}
	                              	    </tr> 
	                              	    {% endfor %}
	                              	    <tr class="odd" style="background-color: #e6e6e6;color:#ff6600;">
	                              	    {% for key,tab in kpis['global'] %}
	                              	      {% if loop.index == 1 %}
			                              	           <td><b>CT(Somme des criticités des risques )</b></td>
			                               {% endif %}
                              	           <td colspan="4"><b>{{ tab['ct'] }}</b></td>
	                              	    {% endfor %}
	                              	    </tr>
	                              	    <tr class="odd" style="background-color: #e6e6e6;color:#ff6600;">
	                              	    {% for key,tab in kpis['global'] %}
					                              	          {% if loop.index == 1 %}
							                              	           <td><b>CMP(Criticité maximale possible )</b></td>
							                                  {% endif %}
				                              	           <td colspan="4"><b>{{ tab['cmp'] }}</b></td>
	                              	   {% endfor %}
	                              	    </tr>
	                              	     <tr class="odd" style="background-color: #e6e6e6;color:#ff6600;">
	                              	    {% for key,tab in kpis['global'] %}
					                              	          {% if loop.index == 1 %}
							                              	           <td><b>ICG(Indice de Criticité Globale)</b></td>
							                                  {% endif %}
				                              	           <td colspan="4"><b>{{ tab['icg']|round }}</b></td>
	                              	   {% endfor %}
	                              	    </tr>
                              	 
                              </tbody>
                              </table>
                         {% else %}
                             <div class="screen-msg"><span class="icon"><img src="{{  asset('bundles/orangemain/images/icon/dialog.png') }}" alt="dialog"></span>Aucunes informations pour ce KPI.</div>
                         {% endif %}
                          </div>
                          <div id="tab2" class="tab_content">
                           {% if kpis['global'] is not empty %}
                          		<div id="graphe" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
                          {% else %}
                             <div class="screen-msg"><span class="icon"><img src="{{  asset('bundles/orangemain/images/icon/dialog.png') }}" alt="dialog"></span>Aucunes informations pour ce KPI.</div>
                         {% endif %}
                          </div>
                      </div>     
      </div>
</div>
                           
<div cl
</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script type="text/javascript">
	categories = [];
	series = [];

	{% for c,value in graphe['risques'] %}
		categories[{{ loop.index0 }}] = '{{ value }}';
	{% endfor %}
	var i=0;
	{% for libelle,val in graphe['years'] %}
			series[{{ loop.index0 }}] = new Object();
			series[{{ loop.index0 }}].name = '{{ libelle|escape('js')  }}';
	{% endfor %}
	{% for libelle, stats in graphe['years'] %}
		series[{{ loop.index0 }}].data = [];
		{%  for cle, val in stats  %}
					series[{{ loop.parent.loop.index0 }}].data.push({{ val }});
		{% endfor %}
	{% endfor %}
	
	$(function () {
	    $('#graphe').highcharts({
	        chart: {
	            type: 'column'
	        },
	        colors: ["#9164cd", "#ff6600"],
	        title: {
	            text: 'Evolution des criticités par risque par année'
	        },
	        lang: {
	        	downloadJPEG: 'Télécharger sous image JPEG',
	        	downloadPNG: 'Télécharger sous image PNG',
	        	downloadSVG: 'Télécharger sous image SVG',
	        	downloadPDF: 'Télécharger sous document PDF',
	        	printChart: 'Imprimer le graphe',
	        	contextButtonTitle: 'Télécharger le graphe'
	    	},
	        xAxis: {
	            categories: categories
	        }, credits:{
		        enabled:false
	        },
	        yAxis: {
	            min: 0,
	            title: {
	                text: 'Criticité'
	            }
	        },
	        tooltip: {
	            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
	            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
	                '<td style="padding:0"><b>{point.y:.0f} </b></td></tr>',
	            footerFormat: '</table>',
	            shared: true,
	            useHTML: true
	        },
	        plotOptions: {
	            column: {
	                pointPadding: 0.2,
	                borderWidth: 0
	            }
	        },
	        series: series
	    });
	});
	</script>
{% endblock %}
