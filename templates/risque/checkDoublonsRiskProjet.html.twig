<script>
    $('#{{ form.projet.vars.id }}').change(function() {
        $("#{{ form.risque.menace.vars.id }} option[value='']").attr('selected', 'selected');
        $("#{{ form.risque.menace.vars.id }}").trigger('liszt:updated');
    });
    
	$('#{{ form.risque.menace.vars.id }}').change(function() {
		if (this.value && $('#{{ form.projet.vars.id }}').val() && $('#{{ form.processus.vars.id }}').val()){
			$.ajax({
                url:"{{ path('risk_check_doublons') }}",
                type:"GET",
                data:{
                    'menace_id': this.value,
                    'projet_id': $('#{{ form.projet.vars.id }}').val(),
                    'processus_id': $('#{{ form.processus.vars.id }}').val(),
                    'structure_id': $('#{{ form.structure.vars.id }}').val()
                },
                success:function (data) {
                    console.log(data);
                    if (data.nbRisk > 0) {
                        //alert('Ce risque existe déjà!');
                        let a=document.createElement('a');
                        a.href=data.url;
                        if (window.confirm('Ce risque existe déjà ! Voir les détails ?'))
                        {
                            a.click();
                        } else {
                            $("#{{ form.risque.menace.vars.id }} option[value='']").attr('selected', 'selected');
                            $("#{{ form.risque.menace.vars.id }}").trigger('liszt:updated');
                        }
                    }
                }
            })
		}
		else if (this.value && $('#{{ form.projet.vars.id }}').val()) {
			$("#{{ form.risque.menace.vars.id }} option[value='']").attr('selected', 'selected');
			$("#{{ form.risque.menace.vars.id }}").trigger('liszt:updated');
			alert('Merci de choisir un processus');
		}
		else if (this.value && $('#{{ form.processus.vars.id }}').val()) {
			$("#{{ form.risque.menace.vars.id }} option[value='']").attr('selected', 'selected');
			$("#{{ form.risque.menace.vars.id }}").trigger('liszt:updated');
			alert('Merci de choisir un projet');
		}
		else if (this.value) {
			$("#{{ form.risque.menace.vars.id }} option[value='']").attr('selected', 'selected');
			$("#{{ form.risque.menace.vars.id }}").trigger('liszt:updated');
			alert('Merci de choisir un processus et un projet !');
		}
	});
</script>
