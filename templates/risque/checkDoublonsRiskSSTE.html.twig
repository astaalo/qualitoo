<script>
    var carto = {{ entity.id is empty ? cartographie_id }};
	$('#{{ form.risque.menace.vars.id }}').change(function() {
		if (this.value && $('#{{ form.site.vars.id }}').val()){
			$.ajax({
                url:"{{ path('risk_check_doublons') }}",
                type:"GET",
                data:{
                    'menace_id': this.value,
                    'site_id': $('#{{ form.site.vars.id }}').val(),
                    'domaine_activite_id': $('#{{ form.domaineActivite.vars.id }}').val(),
                    'equipement_id': $('#{{ form.equipement.vars.id }}').val(),
                    'lieu_id': $('#{{ form.lieu.vars.id }}').val(),
                    'manifestation_id': $('#{{ form.manifestation.vars.id }}').val(),
                    'carto_id': carto
                },
                success:function (data) {
                    console.log(data);
                    if (data.nbRisk > 0) {
                        //alert('Ce risque existe déjà!');
                        let a=document.createElement('a');
                        a.href=data.url;
                        if (window.confirm('Ce risque existe déjà ! Voir les détails ?'))
                        {
                            a.click();
                        } else {
                            $("#{{ form.risque.menace.vars.id }} option[value='']").attr('selected', 'selected');
                            $("#{{ form.risque.menace.vars.id }}").trigger('liszt:updated');
                        }
                    }
                }
            })
		}
		else {
			$("#{{ form.risque.menace.vars.id }} option[value='']").attr('selected', 'selected');
			$("#{{ form.risque.menace.vars.id }}").trigger('liszt:updated');
			alert('Merci de choisir un site');
		}
	});
</script>
