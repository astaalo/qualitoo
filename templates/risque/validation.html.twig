{% extends 'base.html.twig' %}

{% block navigation %} 
	{{ knp_menu_render('OrangeMainBundle:Builder:showMenu', {'template':'extra/knp_menu.html.twig', 'item': {1:'Risque'} }) }}
{% endblock %} 

{% block content %}
	<div class="onecolumn">
		<div class="header">
			<span><span class="ico gray notepad"></span>Validation d'un risque</span>
		</div>
		<div class="clear"></div>
		<div class="content">
			<form action="{{ path('validation_risque', {'id': risque.id}) }}" method="post">
			<!-- Smart Wizard -->
			<div id="wizard" class="swMain">
				<ul>
					<li><a href="#step-1"> <label class="stepNumber">1</label> <span
							class="stepDesc">ère étape<br /> <small>Validation de l'activité</small>
						</span>
					</a></li>
					<li><a href="#step-2"> <label class="stepNumber">2</label> <span
							class="stepDesc">ème étape<br /> <small>Validation des causes</small>
						</span>
					</a></li>
					<li><a href="#step-3"> <label class="stepNumber">3</label> <span
							class="stepDesc">ème étape<br /> <small>Choix du profil du risque</small>
						</span>
					</a></li>
					<li><a href="#step-4"> <label class="stepNumber">4</label> <span
							class="stepDesc">ème étape<br /> <small>Validation des impacts</small>
						</span>
					</a></li>
					<li><a href="#step-5"> <label class="stepNumber">5</label> <span
							class="stepDesc">ème étape<br /> <small>Validation du nom du risque</small>
						</span>
					</a></li>
				</ul>
				
				{# 			Cause and Impact sheepit data               #}
				{% set causeDataForm, impactDataForm = '', '' %}
			{% for causeForm in form.causeOfRisque %}
				{% set row %}
				{
				       {% if causeForm.vars.value.cause.etat==true %}
							{{ '"%s": "%s"'|format(causeForm.cause.vars.name, causeForm.cause.vars.value)|raw }},
						{% else %}
							{{ '"%s": "%s"'|format(causeForm.newCause.libelle.vars.name, causeForm.newCause.libelle.vars.value)|raw }},
						{% endif %}
				},
				{% endset %}
				{% set causeDataForm = causeDataForm ~ row %}
			{% endfor %}
				{% for impactForm in form.impactOfRisque %}
					{% set row %}
					{
						{{ '"%s": "%s"'|format(impactForm.impact.libelle.vars.name, impactForm.impact.libelle.vars.value)|raw }},
						{{ '"%s": "%s"'|format(impactForm.impact.critere.vars.name, impactForm.impact.critere.vars.value)|raw }},
					},
					{% endset %}
					{% set impactDataForm = impactDataForm ~ row %}
				{% endfor %}
				{% set causeDataForm, impactDataForm = '[%s]'|format(causeDataForm|raw), '[%s]'|format(impactDataForm|raw) %}
				{# 			/Cause and Impact sheepit data               #}
				
				{% set errorSteps = "" %}
				<div id="step-1">
				{{ form.vars.value.activite }}
					{% set structureCodeBefore %}
						{% if form.vars.value.activite is empty %}
						<p>Structure saisie lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.identification.structure.vars.value == '' ? 'Aucune' : form.identification.structure.vars.value }}
							</span>
						</p>
						Veuillez choisir la bonne structure dans la liste ci-dessous : <br><br>
						{% endif %}
					{% endset %}
					{% set responsableCodeBefore %}
						{% if form.vars.value.activite is empty %}
						<p>Nom du responsable saisi lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.identification.responsable.vars.value == '' ? 'Aucun' : form.identification.responsable.vars.value }}
							</span>
						</p>
						{% endif %}
						Responsable de la structure choisie : <input type="text" disabled="disabled" id="responsable" value="Aucun"/>
						<br><br>
					{% endset %}
					{% set processusCodeBefore %}
						{% if form.vars.value.activite is empty %}
						<p>Processus saisi lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.identification.processus.vars.value == '' ? 'Aucun' : form.identification.processus.vars.value }}
							</span>
						</p>
						Veuillez choisir le processus dans la liste ci-dessous : <br><br>
						{% endif %}
					{% endset %}
					
					{% set activiteCodeBefore %}
						{% if form.vars.value.activite is empty %}
						<p>Activité saisie lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.identification.activite.vars.value == '' ? 'Aucun' : form.identification.activite.vars.value }}
							</span>
						</p>
						Veuillez choisir l'activité dans la liste ci-dessous : <br><br>
						{% endif %}
					{% endset %}
					
					{{ form_row(form.structure, {'code_before' : structureCodeBefore}) }}
					{{ form_row(form.identification.responsable, {'code_before' : responsableCodeBefore, 'show': false}) }}
					{{ form_row(form.processus, {'code_before' : processusCodeBefore}) }}
					{{ form_row(form.activite, {'code_before' : activiteCodeBefore}) }}
					
					{% if not form.activite.vars.valid %}
						{% set errorSteps = errorSteps ~ "1, " %}
					{% endif %}
				</div>
				<div id="step-2">
					{% set causeSheepItTemplate %}
						{% include 'extra/sheepIt_template.html.twig' with
							{
								'id': form.causeOfRisque.vars.id,
								'prototype' : form.causeOfRisque.vars.prototype, 
								'prototypeTemplate' : 'risque/risque_cause_prototype.html.twig',
								'addText': 'Ajouter une cause', 
								'removeAllText': 'Supprimer toutes les causes',
								'noFormText': 'Aucune cause n\'est encore identifiée !'
							}
						%}
					{% endset %}
					{{ form_row(form.causeOfRisque, {'sheeptIt_template' : causeSheepItTemplate }) }}
					
					{% if not form.causeOfRisque.vars.valid %}
						{% set errorSteps = errorSteps ~ "2, " %}
					{% endif %}
				</div>
				<div id="step-3">
					
					{{ form_row(form.manifestation) }}
					
				</div>
				<div id="step-4">
					{% set impactSheepItTemplate %}
						{% include 'extra/sheepIt_template.html.twig' with
							{
								'id': form.impactOfRisque.vars.id,
								'prototype' : form.impactOfRisque.vars.prototype, 
								'prototypeTemplate' : 'risque/risque_impact_prototype.html.twig',
								'addText': 'Ajouter un impact', 
								'removeAllText': 'Supprimer tous les impacts',
								'noFormText': 'Aucun impact n\'est encore identifié !',
							}
						%}
					{% endset %}
					
					{{ form_row(form.impactOfRisque, {'sheeptIt_template' : impactSheepItTemplate}) }}
					
					{% if not form.impactOfRisque.vars.valid %}
						{% set errorSteps = errorSteps ~ "4, " %}
					{% endif %}
				</div>
				
				<div id="step-5">
					{% set menaceCodeBefore %}
						{% if form.vars.value.menace is empty %}
						<p>Nom saisi lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.identification.libelle.vars.value == '' ? 'Aucun' : form.identification.libelle.vars.value }}
							</span>
						</p>
						Veuillez choisir le nom du risque dans la liste ci-dessous : <br><br>
						{% endif %}
					{% endset %}
					
					{{ form_row(form.menace, {'code_before' : menaceCodeBefore}) }}
					
					{% if not form.menace.vars.valid %}
						{% set errorSteps = errorSteps ~ "5, " %}
					{% endif %}
				</div>
			</div>
			{{ form_row(form._token) }}
			<!-- End SmartWizard Content -->
			</form>
	
			<div class="clear"></div>
		</div>
	</div>
	<!-- // End onecolumn -->
	<script type="text/javascript">
		//wizard 
		$('#wizard').smartWizard({
			 labelNext:'Suivant', // label for Next button
			 labelPrevious:'Précedent', // label for Previous button
			 labelFinish:'Enregistrer',  //
			 errorSteps:[{{ errorSteps }}],
			 transitionEffect: 'slide', 
		});
	</script>

{% include 'extra/reloadSelect.html.twig' with 
	{parent: form.structure, child: form.processus, url: path('get_processus_by_structure'), key: 'id', functionAfter: 'afterStructureReload'} 
%}

{% include 'extra/updateField.html.twig' with 
	{parent: form.structure, fieldId: 'responsable', url: path('get_responsable_by_structure'), key: 'id'} 
%}

{% include 'extra/reloadSelect.html.twig' with 
	{parent: form.processus, child: form.activite, url: path('get_activities_by_processus'), key: 'id', functionAfter: 'afterProcessusReload'} 
%}

{% include 'extra/sheepit.html.twig' with {
				with_script: true,
				content: '#' ~ form.causeOfRisque.vars.id, 
				options: '{' ~
					'iniFormsCount: 0, minFormsCount: 0, indexFormat: "__name__", data: ' ~ causeDataForm ~ ', separator: "", allowRemoveAll: true, ' ~ 
					'afterAdd: function(source, addForm) { $(addForm).find("select").selectmenu({style: "dropdown"}); $("#wizard").smartWizard("fixHeight"); }, ' ~ 
					'afterFill: function(source, addForm, value) { $(addForm).find("select").selectmenu("destroy").selectmenu({style: "dropdown"}); }, ' ~ 
					'removeAllConfirmationMsg: "Vous êtes sur le point de supprimer toutes les causes liées à ce risque. Voulez vous continuer ?", ' ~
					'}', 
				embeddedForm: form.causeOfRisque,
				error_fields: {'cause': { 0:'libelle', 1: 'famille', 2: 'description'} } 
			}
 %}

{% set reload_event %}{% include 'extra/reloadSelectBy.html.twig' with {parent: '$("#' ~ form.profilRisque.vars.id ~ '")', 
		child: '$("#' ~ form.impactOfRisque.vars.id ~ '").find("select.select_child")', url: path('get_critere_by_profile_risque'), key: 'id', only_script: 1, is_js_object: 1, functionAfter: 'refreshSelect' } %}
{% endset %}

{% include 'extra/sheepit.html.twig' with {
				with_script: true,
				content: '#' ~ form.impactOfRisque.vars.id, 
				options: '{' ~
					'iniFormsCount: 0, minFormsCount: 0, indexFormat: "__name__", data: ' ~ impactDataForm ~ ', separator: "", allowRemoveAll: true, ' ~ 
					'afterAdd: function(source, addForm) { $(addForm).find("select").selectmenu({style: "dropdown"});  $("#wizard").smartWizard("fixHeight"); ' ~ reload_event ~ '}, ' ~ 
					'afterFill: function(source, addForm, value) { $(addForm).find("select").selectmenu("destroy").selectmenu({style: "dropdown"}); }, ' ~ 
					'removeAllConfirmationMsg: "Vous êtes sur le point de supprimer tous les impacts liés à ce risque. Voulez vous continuer ?", ' ~
					'}', 
				embeddedForm: form.impactOfRisque, 
				error_fields: { 'impact': {0: 'libelle', 1: 'critere'}}
			}
 %}
{% endblock %}


{% block add_script_js %}
	<script type="text/javascript">

		// code to execute after Select ajax load
		function afterStructureReload() {
			$("#{{ form.processus.vars.id }} option[value='{{ form.processus.vars.value }}']").attr('selected', 'selected');
			$("#{{ form.processus.vars.id }}").trigger('liszt:updated');
		}
		function afterProcessusReload() {
			$("#{{ form.activite.vars.id }} option[value='{{ form.activite.vars.value }}']").attr('selected', 'selected');
			$("#{{ form.activite.vars.id }}").trigger('liszt:updated');
		}

	</script>
	
{% endblock %}
