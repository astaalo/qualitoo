{% extends 'configuration/index.html.twig' %}

{% block menu_config %}
{% endblock %}

{% block header_config %}
<div class="header">
	<span>
		<span class="ico color checkmark2"></span>Validation de risque projet
	</span>
	<div id="buttom_top">
		<ul class="uibutton-group">
			<li><a class="uibutton icon answer" href="{{ path('les_risques') }}">Liste des risques</a></li>
        </ul>
    </div>
</div>
{% endblock %}


{% block content_config %}
	<div class="contentForm">
		
			<form novalidate="novalidate" action="{{ path('validation_risque', {'id': id}) }}" method="post">
				{% set causeDataForm, impactDataForm = '', '' %}
			{% for causeForm in form.risque.causeOfRisque %}
				{% set row %}
				{
				       {% if causeForm.vars.value.cause is empty %}
				       	{{ '"%s": ""'|format(causeForm.cause.vars.name )|raw}},
				       {% elseif causeForm.vars.value.cause.etat==true %} 
							{{ '"%s": "%s"'|format(causeForm.cause.vars.name, causeForm.cause.vars.value)|raw }},
						{% else %}
							{{ '"%s": "%s"'|format(causeForm.newCause.libelle.vars.name, causeForm.newCause.libelle.vars.value)|raw }},
						{% endif %}
				},
				{% endset %}
				{% set causeDataForm = causeDataForm ~ row %}
			{% endfor %}
			
				{% set causeDataForm, impactDataForm = '[%s]'|format(causeDataForm|raw), '[%s]'|format(impactDataForm|raw) %}
				{# 			/Cause and Impact sheepit data               #}
				
				{% set errorSteps = "" %}
						{% set structureCodeBefore %}
						{% if form.vars.value.projet is empty %}
						<p>Structure saisie lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.risque.identification.structure.vars.value == '' ? 'Aucune' : form.risque.identification.structure.vars.value }}
							</span>
						</p>
						Veuillez choisir la bonne structure dans la liste ci-dessous : <br><br>
						{% endif %}
					{% endset %}
					{% set responsableCodeBefore %}
						{% if form.vars.value.projet is empty %}
						<p>Nom du responsable saisi lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.risque.identification.responsable.vars.value == '' ? 'Aucun' : form.risque.identification.responsable.vars.value }}
							</span>
						</p>
						{% endif %}
						Responsable de la structure choisie : <input type="text" disabled="disabled" id="responsable" value="Aucun"/>
						<br><br>
					{% endset %}
					{% set processusCodeBefore %}
						{% if form.vars.value.projet is empty %}
						<p>Processus saisi lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.risque.identification.processus.vars.value == '' ? 'Aucun' : form.risque.identification.processus.vars.value }}
							</span>
						</p>
						Veuillez choisir le processus dans la liste ci-dessous : <br><br>
						{% endif %}
					{% endset %}
					
					{% set menaceCodeBefore %}
						{% if form.vars.value.risque.menace is empty %}
						<p>Nom saisi lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.risque.identification.libelle.vars.value == '' ? 'Aucun' : form.risque.identification.libelle.vars.value }}
							</span>
						</p>
						Veuillez choisir le nom du risque dans la liste ci-dessous : <br><br>
						{% endif %}
					{% endset %}
					
					{% set projetCodeBefore %}
						{% if form.vars.value.projet is empty %}
						<p>Projet saisie lors de l'identification du risque : 
							<span style="color: #222; font-weight: bold;">
								{{ form.risque.identification.projet.vars.value == '' ? 'Aucun' : form.risque.identification.projet.vars.value }}
							</span>
						</p>
						Veuillez choisir le projet dans la liste ci-dessous : <br><br>
						{% endif %}
					{% endset %}
					
					{{ form_row(form.direction) }}
					{{ form_row(form.structure, {'code_before' : structureCodeBefore}) }}
					{{ form_row(form.risque.identification.responsable, {'code_before' : responsableCodeBefore, 'show': false}) }}
					{{ form_row(form.processus, {'code_before' : processusCodeBefore}) }}
					{{ form_row(form.projet, {'code_before' : projetCodeBefore}) }}
					{{ form_row(form.risque.menace, {'code_before' : menaceCodeBefore}) }}
					{% if not form.projet.vars.valid %}
						{% set errorSteps = errorSteps ~ "1, " %}
					{% endif %}
					{% set causeSheepItTemplate %}
						{% include 'extra/sheepIt_template.html.twig' with
							{
								'id': form.risque.causeOfRisque.vars.id,
								'prototype' : form.risque.causeOfRisque.vars.prototype, 
								'prototypeTemplate' : 'risque/risque_cause_prototype.html.twig',
								'addText': 'Ajouter une cause', 
								'removeAllText': 'Supprimer toutes les causes',
								'noFormText': 'Aucune cause n\'est encore identifiée !'
							}
						%}
					{% endset %}
					{{ form_row(form.risque.causeOfRisque, {'sheeptIt_template' : causeSheepItTemplate }) }}
					
					{% if not form.risque.causeOfRisque.vars.valid %}
						{% set errorSteps = errorSteps ~ "2, " %}
					{% endif %}
					{% if not form.risque.menace.vars.valid %}
						{% set errorSteps = errorSteps ~ "5, " %}
					{% endif %}
			{{ form_row(form._token) }}
			<!-- End SmartWizard Content -->
			<div class="section last footer">
				<div>
					<button id="save" class="uibutton loading" >Valider ce risque</button>
					<a class="uibutton special actionLink" href="#myModal" data-toggle="modal" data-target="#myModal" class="actionLink" modal-url="{{ path('rejet_risque', {'id': id}) }}">Rejeter</a>
				</div>
			</div>
			</form>
	
		</div>
	</div>
{% block add_script_js %}
	<script type="text/javascript">
$(function() {
			$nouvelle_cause=$( ".risque_cause_row .section:eq(2)" );
			
			$nouvelle_cause.hide();
				$('input[type="checkbox"].choix').live('change', function(e) {
					console.log('ok');
					$nouvelle_cause=$(this).parent().parent().parent().children('.section:last');
					if($(this).prop( "checked" )) {
						$nouvelle_cause.show( );
					}else{
						$nouvelle_cause.hide( );
					}
				});
			});
		// code to execute after Select ajax load
		function afterDirectionReload() {
			$("#{{ form.structure.vars.id }} option[value='{{ form.structure.vars.value }}']").attr('selected', 'selected');
			$("#{{ form.structure.vars.id }}").trigger('liszt:updated');
		}
		
		function afterStructureReload() {
			$("#{{ form.processus.vars.id }} option[value='{{ form.processus.vars.value }}']").attr('selected', 'selected');
			$("#{{ form.processus.vars.id }}").trigger('liszt:updated');
		}
		
	</script>
	
{% endblock %}
{% include 'extra/reloadSelect.html.twig' with 
	{parent: form.direction, child: form.structure, url: path('structure_by_parent'), key: 'id', empty_child: 1, functionAfter: 'afterDirectionReload'} 
%}

{% include 'extra/reloadSelect.html.twig' with 
	{parent: form.structure, child: form.processus, url: path('get_processus_by_structure'), key: 'id', functionAfter: 'afterStructureReload'} 
%}

{% include 'extra/updateField.html.twig' with 
	{parent: form.structure, fieldId: 'responsable', url: path('get_responsable_by_structure'), key: 'id'} 
%}


{% include 'extra/sheepit.html.twig' with {
				with_script: true,
				content: '#' ~ form.risque.causeOfRisque.vars.id, 
				options: '{' ~
					'iniFormsCount: 0,
					 minFormsCount: 0, 
					 indexFormat: "__name__", data: ' ~ causeDataForm ~ ', 
					 separator: "", allowRemoveAll: true, ' ~ 
					 'afterAdd: function(source, addForm ,causeDataForm) { refreshChosen($(".cl_cause"),causeDataForm);  },' ~
					'removeAllConfirmationMsg: "Vous êtes sur le point de supprimer toutes les causes liées à ce risque. Voulez vous continuer ?", ' ~
					'}', 
				embeddedForm: form.risque.causeOfRisque,
				error_fields: {0 :'cause', 'newCause': { 0:'libelle' }} 
			}
 %}



{% endblock %}
